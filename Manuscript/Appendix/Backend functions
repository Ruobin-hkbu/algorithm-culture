import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const SYSTEM_PROMPT = `You are "Room C — Human-in-the-loop Copy Assistant". Your job is to produce persuasive, professional, and ethically-safe healthcare advertising copy while prioritizing value-aligned safety and transparency.

IMPORTANT: Respond in natural, conversational text format. DO NOT output JSON. Present information in a readable, human-friendly way.

Follow these rules for every request:

1. Always begin by confirming the ad brief (audience, product/service, tone, length, legal/regulatory constraints). If any required detail is missing, ask one concise clarifying question.

2. Produce up to three distinct candidate outputs. For each option (A, B, C), clearly present in plain text:
   - **Headline** (6–12 words)
   - **Body Copy** (2–3 short paragraphs, max 60–90 words total)
   - **Call-to-Action** (one clear line)
   - **Why This Works**: Brief explanation (1–2 lines) of why this option fits the brief

3. For each option, include a conversational safety assessment:
   - Ethics score (out of 7)
   - Any potential concerns (e.g., stigmatizing language, guarantees, vulnerable-audience appeals)
   - Publishing recommendation (Yes/No with brief reason)

4. If any option contains high-risk elements (medical guarantees, vulnerability exploitation, disallowed claims), clearly flag that it needs human review.

5. Keep language plain and accessible. Avoid clinical directives, don't give medical advice, and never fabricate study data or guarantees.

6. Follow local legal/regulatory constraints from the brief. If none are supplied, remind the user to confirm compliance.

7. CRITICAL: Write your entire response in natural, conversational prose. Use proper formatting (bold, bullets, sections) but absolutely NO JSON output. Make it easy to read and understand like a friendly colleague presenting ideas.
`;

async function callOpenRouter(apiKey: string, messages: any[]) {
  const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`,
      "HTTP-Referer": Deno.env.get("SUPABASE_URL") || "https://lovable.dev",
      "X-Title": "CopyCreator AI Assistant",
    },
    body: JSON.stringify({
      model: "openai/gpt-4o-mini", // Default model, you can change this
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        ...messages,
      ],
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    console.error("OpenRouter API error:", error);
    throw new Error(`OpenRouter API error: ${error}`);
  }

  const data = await response.json();
  return data.choices?.[0]?.message?.content ?? "";
}

async function callLovableAI(gatewayKey: string, messages: any[]) {
  const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${gatewayKey}`,
    },
    body: JSON.stringify({
      model: "google/gemini-2.5-flash",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        ...messages,
      ],
      stream: false,
    }),
  });

  if (!response.ok) {
    if (response.status === 429) {
      throw new Error("Rate limits exceeded, please try again later.");
    }
    if (response.status === 402) {
      throw new Error("Payment required, please add credits to your Lovable AI workspace.");
    }
    const error = await response.text();
    throw new Error(`Lovable AI gateway error: ${error}`);
  }

  const data = await response.json();
  return data.choices?.[0]?.message?.content ?? "";
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages = [] } = await req.json();
    console.log("Received request with messages:", messages?.length ?? 0);

    const openAIKey = Deno.env.get("OPENAI_API_KEY");
    const lovableKey = Deno.env.get("LOVABLE_API_KEY");

    let content = "";

    // Check if OpenRouter key is configured
    if (openAIKey && /^sk-or-/i.test(openAIKey)) {
      console.log("Provider: OpenRouter");
      content = await callOpenRouter(openAIKey, messages);
    } else if (lovableKey) {
      console.log("Provider: Lovable AI Gateway");
      content = await callLovableAI(lovableKey, messages);
    } else {
      throw new Error("No AI provider configured. Please set OPENAI_API_KEY (for OpenRouter) or ensure LOVABLE_API_KEY is available.");
    }

    return new Response(
      JSON.stringify({ message: content }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    console.error("Error in copywriting-assist function:", error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : "Unknown error" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
